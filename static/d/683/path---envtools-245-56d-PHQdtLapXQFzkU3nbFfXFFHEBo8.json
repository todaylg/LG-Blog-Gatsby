{"data":{"post":{"id":"463189d9-57f4-5739-803a-bcea665bda89","html":"<p>我们知道实时PBR渲染中的IBL部分是可以预计算的，主要包括：</p>\n<ul>\n<li>\n<p>Diffuse部分：辐照度图(irradiance map)或SH(Spherical Harmonics)</p>\n</li>\n<li>\n<p>Specular部分：不同粗糙度级别对应的环境贴图、BRDF积分(LUT)</p>\n</li>\n</ul>\n<p>一些部分也可通过近似来达到实时计算：</p>\n<p>比如LUT可以通过数学曲线来近似：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token comment\">// https://www.unrealengine.com/blog/physically-based-shading-on-mobile</span>\n<span class=\"token keyword\">vec3</span> <span class=\"token function\">integrateBRDF</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">in</span> <span class=\"token keyword\">vec3</span> specular<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">in</span> <span class=\"token keyword\">float</span> roughness<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">in</span> <span class=\"token keyword\">float</span> NoV<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">in</span> <span class=\"token keyword\">float</span> f90<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">vec4</span> c0 <span class=\"token operator\">=</span> <span class=\"token keyword\">vec4</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.0275</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.572</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.022</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">vec4</span> c1 <span class=\"token operator\">=</span> <span class=\"token keyword\">vec4</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0425</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.04</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.04</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">vec4</span> r <span class=\"token operator\">=</span> roughness <span class=\"token operator\">*</span> c0 <span class=\"token operator\">+</span> c1<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> a004 <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> r<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> <span class=\"token function\">exp2</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">9.28</span> <span class=\"token operator\">*</span> NoV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> r<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> r<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">vec2</span> AB <span class=\"token operator\">=</span> <span class=\"token keyword\">vec2</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1.04</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.04</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> a004 <span class=\"token operator\">+</span> r<span class=\"token punctuation\">.</span>zw<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> specular <span class=\"token operator\">*</span> AB<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> AB<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> f90<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>以及Three R112以后直接纳入核心API的PMREM(Prefiltered Mipmapped Radiance Environment Map)</p>\n<p>这里又歪出来跪一会，R112之前的PMREM是由Prashant Sharma老哥实现的，和这位印度老哥有过一些交流，其已是自由职业，不仅Shader写得惊为天人，甚至还保持着晨练的健康习惯，代码好又身体壮，xmsl。。。</p>\n<p>近似和简化毕竟还是会造成一定的效果损失，所以一个好的离线预计算Envtools其实很关键。</p>\n<p>现有的一些处理工具包括:</p>\n<ul>\n<li>\n<p>babylon使用的<a href=\"https://github.com/derkreature/IBLBaker\">IBLBaker</a></p>\n</li>\n<li>\n<p>filament的<a href=\"https://github.com/google/filament/tree/master/filament\">cmgen</a></p>\n</li>\n<li>\n<p>ogl使用的<a href=\"https://github.com/oframe/ibl-converter\">ibl-converter</a></p>\n</li>\n<li>\n<p>osg.js使用的<a href=\"https://github.com/cedricpinson/envtools\">envtools</a></p>\n</li>\n</ul>\n<p>但要数其中功能最多最强大的，那还得看envtools。</p>\n<p>毕竟宇宙最强Web渲染SketchFab便是基于osg.js的。</p>\n<h2>Envtools</h2>\n<p>在简单的学习一些涉及的知识后（Docker、Cmake、C++、Python）后，便可以一窥强大的envtools到底都干了啥啦。。</p>\n<p><a href=\"https://github.com/todaylg/envTools\">envTools</a></p>\n<p>核心指令：</p>\n<h2>envremap</h2>\n<p>提供任意两种格式之间的转换，包括：</p>\n<p><strong>rect</strong></p>\n<p>极坐标映射，入射方向r(x,y,z)对应的纹理坐标为：</p>\n<p><img src=\"https://latex.codecogs.com/gif.latex?%5Ctheta%20%3D%20arccos%28z%29\" alt=\"image\"></p>\n<p><img src=\"https://latex.codecogs.com/gif.latex?%5Cvarphi%20%3D%20atan2%28ry%2Crx%29\" alt=\"image\"></p>\n<p>投影计算包含反三角函数，计算效率不高，且在两极附近会有较大拉伸。</p>\n<p><strong>ball</strong></p>\n<p>球面映射，缺点是采样分布非常不均匀，球面边缘附近大量方向会被映射到边缘较窄的面积。</p>\n<p><strong>cube</strong></p>\n<p>立方体映射，目前使用最多的映射方式。</p>\n<p>关于seamless CubeMap的问题，CubeMap在边缘的顶点采样需要考虑其他面，即需额外采样相邻面进行插值才能得到正确的结果。</p>\n<p>WebGL已经提供了<a href=\"https://www.khronos.org/opengl/wiki/Cubemap_Texture#Seamless_cubemap\">API</a>支持，但一些老的浏览器并不支持seamless CubeMap，envtools的解决方法：<a href=\"https://github.com/castano/nvidia-texture-tools/blob/master/src/nvtt/CubeSurface.cpp\">Nvidia的texture-tools的修复方法</a></p>\n<p>剩下的<strong>dome</strong>、<strong>hemi</strong>介绍可见Readme，不赘述</p>\n<p>在格式转换过程中还可以控制不同的超采样方法(cent/rgss/box2/box3/box4)</p>\n<p>Three中也提供了实时的直方图转CubeMap方法，即WebGLRenderTargetCube.fromEquirectangularTexture（R110之前为EquirectangularToCubeGenerator）</p>\n<h2>envIrradiance</h2>\n<p>生成irradiance map并输出SH，计算全局光照中的间接光照</p>\n<p>SH可以用作近似irradiance map，通过SH coefficients可重建低频的环境光</p>\n<p>相关文章：</p>\n<ul>\n<li>\n<p><a href=\"https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\">https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf</a></p>\n</li>\n<li>\n<p><a href=\"https://zhuanlan.zhihu.com/p/63755519\">https://zhuanlan.zhihu.com/p/63755519</a></p>\n</li>\n<li>\n<p><a href=\"https://zhuanlan.zhihu.com/p/50208005\">https://zhuanlan.zhihu.com/p/50208005</a></p>\n</li>\n</ul>\n<p>Three目前对IBL的间接光照部分计算用的是环境贴图的最低一级的mipmap（见函数getLightProbeIndirectIrradiance）</p>\n<p>对SH的相关的讨论：</p>\n<ul>\n<li>\n<p><a href=\"https://github.com/mrdoob/three.js/pull/13115\">https://github.com/mrdoob/three.js/pull/13115</a></p>\n</li>\n</ul>\n<h2>envPrefilter</h2>\n<p>不同粗糙度对应预计算得到的CubeMap，相关文章:</p>\n<ul>\n<li>\n<p><a href=\"https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\">https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf</a> p67</p>\n</li>\n<li>\n<p><a href=\"https://placeholderart.wordpress.com/2015/07/28/implementation-notes-runtime-environment-map-filtering-for-image-based-lighting/\">https://placeholderart.wordpress.com/2015/07/28/implementation-notes-runtime-environment-map-filtering-for-image-based-lighting/</a></p>\n</li>\n</ul>\n<p>Three PMREM(^R112)的实现，直接上的高斯模糊（应用在球面极坐标系），也没有见到相关的Refer，算是个<a href=\"https://github.com/mrdoob/three.js/pull/18004\">Hack</a>吗？。。</p>\n<h2>envBRDF</h2>\n<p>单独计算并输出BRDF的LUT, 相关文章:</p>\n<ul>\n<li>\n<p><a href=\"http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\">http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf</a></p>\n</li>\n</ul>\n<h2>envBackground</h2>\n<p>耗时最长的一步，相关文章：</p>\n<ul>\n<li>\n<p><a href=\"http://stackoverflow.com/questions/17841098/gaussian-blur-standard-deviation-radius-and-kernel-size\">http://stackoverflow.com/questions/17841098/gaussian-blur-standard-deviation-radius-and-kernel-size</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.nvidia.com/gpugems/gpugems3/part-vi-gpu-computing/chapter-40-incremental-computation-gaussian\">https://developer.nvidia.com/gpugems/gpugems3/part-vi-gpu-computing/chapter-40-incremental-computation-gaussian</a></p>\n</li>\n</ul>\n<p>filament是直接延用按粗糙度模糊的方法，速度相对较快。</p>\n<h2>extractLights</h2>\n<p>分析环境贴图中的明亮区域，从而提取出方向光的方向及亮度等信息</p>\n<p>一般用于提取环境贴图中的太阳信息，Viewer中可以在相应位置通过添加一盏方向光来模拟太阳。</p>\n<p>相关文章：</p>\n<ul>\n<li>\n<p><a href=\"http://gl.ict.usc.edu/Research/MedianCut/\">http://gl.ict.usc.edu/Research/MedianCut/</a></p>\n</li>\n<li>\n<p><a href=\"https://gist.github.com/Kuranes/fa7466291c9fad3cdfb845f80fabe646\">https://gist.github.com/Kuranes/fa7466291c9fad3cdfb845f80fabe646</a></p>\n</li>\n</ul>\n<h2>process_environment</h2>\n<p>串联起所有模块的控制入口，除了上面的模块外还添加了：</p>\n<ul>\n<li>\n<p>压缩打包</p>\n</li>\n<li>\n<p>缩略图生成</p>\n</li>\n<li>\n<p>GPU计算加速</p>\n</li>\n</ul>\n<p>其基本流程为：</p>\n<h3>initBaseTexture</h3>\n<p>通过oiiotool(OpenImageIO)将输入文件转化为tiff格式的panorama_highres，调用envremap_cmd生成cubemap_highres</p>\n<h3>thumbnail_create</h3>\n<p>通过oiiotool将cubemap_highres缩放到所需缩小的尺寸即可</p>\n<h3>cubemap_specular_create_mipmap</h3>\n<p>调用envremap_cmd将cubemap_highres按mipmap级数进行resize，加速后面的预处理</p>\n<h3>specular_create_prefilter</h3>\n<p>调用envPrefilter_cmd进行预处理(panorama、cubeMap)，有mipmap的话则直接加载mipmap</p>\n<h3>extract_lights</h3>\n<p>通过oiiotool将panorama_highres缩放1024x512，再调用extractLights_cmd输出灯光信息</p>\n<h3>background_create</h3>\n<p>按传入的background_size复用对应尺寸的mipmap(没有则取第一层)，再调用envBackground_cmd进行背景模糊处理</p>\n<h3>compute_irradiance</h3>\n<p>调用envIrradiance_cmd对cubemap_highres分析输出irradiance Map及输出shCoef</p>\n<h3>compute_brdf_lut_ue4</h3>\n<p>调用envIntegrateBRDF_cmd输出lut</p>\n<h3>cubemap_packer</h3>\n<p>调用cubemap_packer_cmd将mipmap数据打包为二进制，在viewer中再进行解包</p>\n<h3>compress</h3>\n<p>调用compress_7Zip_cmd对图片资源进行压缩</p>\n<h3>writeConfig</h3>\n<p>将所有相关信息输出到config.json</p>\n<h3>zip</h3>\n<p>最后调用compress_zip_cmd将整个文件进行zip打包</p>\n<p>整个envTools应用的效果可见：<a href=\"https://github.com/todaylg/three-viewer\">https://github.com/todaylg/three-viewer</a></p>\n<h2>Todo</h2>\n<ul>\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" checked disabled> 升级Unbutu及相关依赖包，删除冗余依赖</p>\n</li>\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" checked disabled> 仅打包Viewer所需资源，直接输出为单个zip包</p>\n</li>\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" disabled> 直接输出多级背景模糊</p>\n</li>\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" disabled> 学习如何应用OpenCL/Cuda计算加速</p>\n</li>\n</ul>","fields":{"slug":"/envtools/","prefix":"2020-3-03"},"frontmatter":{"title":"EnvTools","author":"todaylg","category":"大结","cover":{"childImageSharp":{"resize":{"src":"/static/bg-cc151178e72298ab770d584036b4ec1c-ada8c.jpg"}}}}},"authornote":{"id":"20cdfd79-00b3-57fb-a29f-bb96dcd133a8","html":"<p><strong>todaylg</strong> </p>"},"site":{"siteMetadata":{"facebook":{"appId":""}}}},"pageContext":{"slug":"/envtools/","prev":{"id":"dbb2deb5-1764-52c5-9309-c591f53e4b0e","fields":{"slug":"/zelda/","prefix":"2020-2-18","source":"posts"},"frontmatter":{"title":"海拉鲁之旅","category":"废话集"}},"next":{"id":"3bdfb94d-b75b-588b-a90a-f3b10547e308","fields":{"slug":"/viewer-pbr/","prefix":"2020-3-19","source":"posts"},"frontmatter":{"title":"Viewer与PBR","category":"大结"}},"source":"posts"}}