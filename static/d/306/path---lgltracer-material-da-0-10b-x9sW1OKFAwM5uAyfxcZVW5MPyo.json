{"data":{"post":{"id":"301bd9f1-c11e-5291-9864-d306e3fefad6","html":"<p>材质部分实现的是Disney BSDF，这里再做一次从基础开始的总结，比较熟悉的兄弟可直接跳过了哈</p>\n<p>首先一切的一切，都得从渲染方程开始：</p>\n<p>$$ L<em>{o}\\left(p, \\omega</em>{o}\\right)=L<em>{e}\\left(p, \\omega</em>{o}\\right)+\\int<em>{\\Omega^{+}} L</em>{i}\\left(p, \\omega<em>{i}\\right) f</em>{r}\\left(p, \\omega<em>{i}, \\omega</em>{o}\\right)\\left(n \\cdot \\omega<em>{i}\\right) \\mathrm{d} \\omega</em>{i} $$</p>\n<h2>辐射度量学</h2>\n<p>而要理解渲染方程，得先回顾下辐射度量学的一些基本概念：</p>\n<h3><strong>辐射能(radiant energy)</strong>：</h3>\n<p>表示以辐射的形式发射、传播或接收的能量。单位为焦耳(J)，使用符号Q表示。每个光子都携带一定的能量，这个能量正比于它的频率v，h为普朗克常数：</p>\n<p>$$ Q = hv $$ </p>\n<h3><strong>辐射通量(radiant flux)</strong>：</h3>\n<p>表示光源每秒钟发射的功率，单位为瓦特(Watt)，使用符号$\\Phi$表示：</p>\n<p>$$ \\Phi\\equiv\\frac{dQ}{dt} $$</p>\n<p>辐射能量测量中通常都使用辐射通量</p>\n<h3><strong>立体角(solid angle)</strong>：</h3>\n<p>表示单位球体上一块区域对应的球面部分的面积，2D使用弧度表示“角度”大小，3D则使用单位球体上区域面积来表示对应“立体角”的大小。</p>\n<p>常用 ω 来表示，单位为 sr(steradian，球面度)，其值为该角对应的面积除以半径的平方:</p>\n<p>$$ \\omega = \\frac{A}{r^2} $$</p>\n<p>微分视角下，可用弧长乘弧长的矩形面积来表示立体角对应的面积dA：</p>\n<p>$$ dA = (dθ<em>r)</em>(dφ<em>r</em>\\cosθ) $$</p>\n<p>微分立体角即为：</p>\n<p>$$ d\\omega = \\frac{dA}{r^2}=\\sinθdθdφ $$</p>\n<p>可顺带推出整个球的表面积：</p>\n<p>$$ A=\\int<em>{0}^{2\\pi}\\int</em>{0}^{\\pi}dA = \\int<em>{0}^{2\\pi}\\int</em>{0}^{\\pi} \\sin\\theta r^{2}d\\theta d \\varphi = r^{2}\\int<em>{0}^{2\\pi}[-cos\\theta]</em>{0}^{\\pi}d \\varphi = r^{2}[2\\varphi]_{0}^{2\\pi} = 4 \\pi r^2 $$</p>\n<h3><strong>辐射强度(radiant intensity)</strong>：</h3>\n<p>表示单位立体角所对应的辐射通量，用 I 来表示，单位为 W/sr:</p>\n<p>$$ I\\equiv \\frac{d\\Phi}{d\\omega} $$</p>\n<h3><strong>辐射照度(irradiance)</strong>：</h3>\n<p>表示单位面积接收到的辐射通量，使用E表示，单位为$W/m^2$：</p>\n<p>$$ E\\equiv\\frac{d\\Phi}{dA} $$</p>\n<p>辐射强度随方向与面法线的夹角余弦变化而变化：</p>\n<p>$$ E=\\frac{d\\Phi}{dA}\\cos\\theta $$</p>\n<h3><strong>辐射亮度/辐射率(radiance)</strong>：</h3>\n<p>表示单位面积下接收到的来自单位立体角的辐射通量，用 L 来表示，单位为$W/sr\\cdot m^2$：</p>\n<p>$$ L(p,\\omega)=\\frac{d^2\\Phi}{d\\omega dA^{\\bot}}\\ $$</p>\n<p>需要注意的是定义irradiance时面积元是$dA$，而定义radiance时是投影后的面积元${d} A^{\\perp}$</p>\n<p>微分视角下radiance即代表单束光线从某个方向射向某个位置的辐射通量（立体角足够小 => 代表方向，面积足够小 => 代表点）</p>\n<h3><strong>radiance与irradiance的关系</strong>：</h3>\n<p>设一束光线的辐射率为L(p,ω)，则可得ω方向上对P点贡献的辐照度dE(p,ω)为：</p>\n<p>$$ dE(p,ω)=L(p,ω) cos\\theta d\\omega $$</p>\n<p>最终P点的辐照度就应该是半球内所有光线提供的辐照度的积分（$\\Omega^{+}$代表正半球域）：</p>\n<p>$$ E(p)=\\int<em>{\\Omega^{+}}L</em>i(p,\\omega<em>i)n\\cdot \\omega</em>i d\\omega_i $$</p>\n<p>回看渲染方程：</p>\n<p>$$ L<em>{o}\\left(p, \\omega</em>{o}\\right)=L<em>{e}\\left(p, \\omega</em>{o}\\right)+\\int<em>{\\Omega^{+}} L</em>{i}\\left(p, \\omega<em>{i}\\right) f</em>{r}\\left(p, \\omega<em>{i}, \\omega</em>{o}\\right)\\left(n \\cdot \\omega<em>{i}\\right) \\mathrm{d} \\omega</em>{i} $$</p>\n<p>只看反射方程，现在就只剩下$f<em>r(p,\\omega</em>i,\\omega_o)$啦</p>\n<h2>双向反射分布函数（BRDF，Bidirectional Reflectance Distribution Function）</h2>\n<p>BRDF的定义是出射Radiance比入射Irradiance的比值，表示反射方向上radiance增量与入射方向irradiance增量的比率(以描述表面入射光与反射光的关系):</p>\n<p>$$ f<em>r(p,\\omega</em>i,\\omega<em>o) = \\frac{L(p,\\omega</em>o)}{L(p,\\omega<em>i)n\\cdot \\omega</em>i d\\omega_i} $$</p>\n<p>BRDF的两个性质：</p>\n<p>1.赫姆霍兹互反定律：BRDF的入射方向和出射方向可以互换，值保持不变：</p>\n<p>$$ f<em>r(p,\\omega</em>i,\\omega<em>o) = f</em>i(p,\\omega<em>i,\\omega</em>o) $$</p>\n<p>2.能量守恒定律：所有反射的能量不能大于所有吸收的能量(不包括自发光)</p>\n<p>$$ \\int<em>{\\Omega}f</em>r(p,\\omega<em>i,\\omega</em>o)n\\cdot \\omega<em>i d\\omega</em>i &#x3C;= 1$$</p>\n<p>即给定一个入射方向，所有出射方向的BRDF积分值小于1</p>\n<p>再回顾一些概念：</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/56967462\">https://zhuanlan.zhihu.com/p/56967462</a> 中的人眼视觉、物理光学(反射/折射/散射/吸收) 部分</p>\n<h3><strong>菲涅尔方程</strong>：</h3>\n<p>详细介绍可见：<a href=\"https://zhuanlan.zhihu.com/p/56967462\">https://zhuanlan.zhihu.com/p/56967462</a> 中的菲涅尔反射部分</p>\n<p>菲涅尔方程描述了反射与折射的比率</p>\n<p>因为菲涅尔反射率大部分范围内趋近于F0，所以F0也称为材质的特征镜面反射率(characteristic specular reflectance)，同时因为满足具有RGB分量且在0-1之间，通常还称为镜面颜色(specular color)</p>\n<p>F0可通过折射率公式计算。折射到表面中的光量即为1-F0</p>\n<p>$$\nF<em>0 = (\\frac{n</em>1-n<em>2}{n</em>1+n_2})^2 \\\n$$</p>\n<p>通常假设n1=1近似于空气的折射率，并用n替换n2</p>\n<p>$$\nF_0 = (\\frac{n-1}{n+1})^2 \\\n$$</p>\n<p>折射定律：</p>\n<p>$$\nn1sinθ1=n2sinθ2\n$$</p>\n<p>大多数常见电介质的F0范围为0.02-0.05, 对于导体，F0范围为0.5-1.0</p>\n<h3><strong>法线分布函数(Normal Distribution Function)</strong>：</h3>\n<p>详细介绍可见：<a href=\"https://zhuanlan.zhihu.com/p/69380665\">https://zhuanlan.zhihu.com/p/69380665</a></p>\n<p>NDF描述了微观表面上的表面法线m的统计分布</p>\n<p>明确定义：单位宏表面上法向量为m的微表面总面积的球面密度</p>\n<p>仅在微观表面法线m等于宏观表面的半矢量h朝向相同的表面点，才<strong>有机会</strong>(最终能不能传播到还取决于G项)被观察到</p>\n<p>NDF的本质是一个密度函数(即具有正确朝向的微表面法线浓度)，单位为1/球面度(1/steradians)</p>\n<p>投影到宏观表面平面上的微平面区域，等于宏观表面的面积，即任何一个法线分布函数D(m)都必须满足在宏表面投影面积为1，投影D(m)(n·m)是被归一化的：</p>\n<p>$$\n\\int_{\\mathbf{m}\\in \\Theta} D(\\mathbf{m})\\mathbf{(n \\cdot m)}d \\mathbf{m} = 1 \\\n$$</p>\n<p>任何方向上微观表面投影面积始终与宏观表面投影面积相同（宏观法线n，微观法线m）</p>\n<p>$$ \\int_{\\mathbf{m}\\in \\Theta} D(\\mathbf{m})\\mathbf{(v \\cdot m)}d \\mathbf{m} = \\mathbf{v \\cdot n} \\ $$</p>\n<p>Θ符号表示在整球体上积分，半球积分用Ω表示。图形学中使用的大多数微结构模型都是高度场（heightfields），这意味着对于Ω外的所有方向，D(m) = 0。 但是，上式也适用于非高度场微观结构。</p>\n<h3><strong>几何函数(Geometry Function)</strong></h3>\n<p>详细介绍可见：<a href=\"https://zhuanlan.zhihu.com/p/81708753\">https://zhuanlan.zhihu.com/p/81708753</a></p>\n<p>几何函数表示在具有半矢量法线的微平面中(满足了m = h)，未被遮挡的百分比。</p>\n<p>两种微表面的交互行为：</p>\n<ul>\n<li>阴影（Shadowing）表示微平面对入射光的遮挡，一般为对光源方向L而言</li>\n<li>遮蔽（masking）表示微平面对出射光的遮挡，一般为对观察方向V而言</li>\n</ul>\n<p>G与D的联系：</p>\n<p>1.几何函数的解析形式的确认依赖于法线分布函数</p>\n<p>2.法线分布函数需要结合几何函数，得到有效的法线分布强度</p>\n<h2><strong>Cook-Torrance BRDF</strong></h2>\n<p>$$ f<em>{r}=k</em>{d} f<em>{lambert}+k</em>{s} f_{cook-torrance} \\ $$</p>\n<h3><strong>漫反射项:</strong></h3>\n<p>也是从反射方程开始：</p>\n<p>$$ L<em>o(\\omega</em>{o}) = \\int<em>\\Omega f</em>{r} L<em>i(\\omega</em>{i}) cos(\\theta<em>i) d\\omega</em>i $$</p>\n<p>因为漫反射是均匀向整个半球方向反射(Labertian模型)，则$f<em>{r}$为常数，且$L</em>i$与方向无关，并且$L<em>o = cL</em>i$，c为反照率/固有色，表示光在介质内部出射部分比例</p>\n<p>$$ L<em>o = f</em>{r} L<em>i \\int</em>\\Omega  cos(\\theta<em>i) d\\omega</em>i = c\\pi f<em>{r} L</em>i $$</p>\n<p>则：</p>\n<p>$$ f_{lambert}=\\frac{c}{\\pi} \\ $$</p>\n<p><strong>积分$\\int _{\\Omega} \\cos \\phi, d\\omega$的计算：</strong></p>\n<p>$\\int _{\\Omega} \\cos \\phi, d\\omega$是半球积分，将其转为球坐标系可得:</p>\n<p>$$ \\int _{\\Omega} \\cos \\phi, d\\omega = \\int _{0} ^{2\\pi} \\int _{0} ^{\\pi / 2} \\sin \\phi ,\\cos \\phi ,d\\phi ,d\\theta $$</p>\n<p>换元：</p>\n<p>$$ \\int _{0} ^{\\pi / 2} \\sin \\phi \\cos \\phi d\\phi = \\frac 1 2 \\int _{0} ^{\\pi / 2}  \\sin \\phi, d(\\sin \\phi) = \\frac 1 2 \\sin^2(2\\phi) | _{0} ^{\\pi / 2} = \\frac 1 2 (1^2 - 0^2) = \\frac 1 2  $$</p>\n<p>再带入后即可得：</p>\n<p>$$ \\int _{\\Omega} \\cos \\phi, d\\omega = \\int _{0} ^{2\\pi} \\frac 1 2 d\\theta = \\pi $$</p>\n<h3><strong>镜面反射项:</strong></h3>\n<p>$$ f_{cook-torrance}=\\frac{F(l, h) G(l, v) D(h)}{4(n \\cdot l)(n \\cdot v)} \\ $$</p>\n<p>D(h)代表每单位面积中每单位立体角所有法向为h的微平面的面积</p>\n<p>则对于面积为dA的微表面，出射面积即为：</p>\n<p>$$ d^2A\\left(\\omega<em>{h}\\right)=D\\left(\\omega</em>{h}\\right) d \\omega_{h} d A $$</p>\n<p>$\\omega<em>i$为入射方向，$\\omega</em>o$为观察方向，$\\omega_h$为微平面法向</p>\n<p>$dA(\\omega<em>h)$是微表面中法线方向为$\\omega</em>h$的面积，入射面积即为这个面积投影到入射平面上:</p>\n<p>$$cos(\\theta_h)dA$$</p>\n<p>设入射radiance为$L<em>{i}\\left(\\omega</em>{i}\\right)$, 则入射的辐射通量：</p>\n<p>$$\n\\begin{aligned} d^3\\Phi<em>{i}&#x26;=L</em>{i}\\left(\\omega<em>{i}\\right) d \\omega</em>{i} d^2 A^{\\perp}\\left(\\omega<em>{h}\\right)\\&#x26;=L</em>{i}\\left(\\omega<em>{i}\\right) d \\omega</em>{i} \\cos \\theta<em>{h} d^2 A\\left(\\omega</em>{h}\\right) \\&#x26;=L<em>{i}\\left(\\omega</em>{i}\\right) d \\omega<em>{i} \\cos \\theta</em>{h} D\\left(\\omega<em>{h}\\right) d \\omega</em>{h} d A \\end{aligned} \\\n$$</p>\n<p>先不考虑F、G项的光线损失，则入射辐射通量等于出射辐射通量：</p>\n<p>$$ d^3 \\Phi<em>{o}=d^3 \\Phi</em>{i} \\ $$</p>\n<p>由radiance的定义，出射radiance为：</p>\n<p>$$ d L<em>{o}\\left(\\omega</em>{o}\\right)=\\frac{d^3 \\Phi<em>{o}}{d \\omega</em>{o} \\cos \\theta<em>{o} d A}=\\frac{ L</em>{i}\\left(\\omega<em>{i}\\right) d \\omega</em>{i} \\cos \\theta<em>{h} D\\left(\\omega</em>{h}\\right) d \\omega<em>{h} d A}{d \\omega</em>{o} \\cos \\theta_{o} d A} \\ $$</p>\n<p>再由BRDF定义：</p>\n<p>$$ f<em>{cook-torrance}\\left(\\omega</em>{i}, \\omega<em>{o}\\right)=\\frac{d L</em>{o}\\left(\\omega<em>{o}\\right)}{d E</em>{i}\\left(\\omega<em>{i}\\right)}=\\frac{d L</em>{o}\\left(\\omega<em>{o}\\right)}{L</em>{i}\\left(\\omega<em>{i}\\right) \\cos \\theta</em>{i} d \\omega<em>{i}}=\\frac{\\cos \\theta</em>{h} D\\left(\\omega<em>{h}\\right) d \\omega</em>{h}}{\\cos \\theta<em>{o} \\cos \\theta</em>{i} d \\omega_{o}} \\ $$</p>\n<p>$\\theta<em>i$是入射光线$\\omega</em>i$与宏观法线方向n的夹角，$\\theta<em>o$是出射光线$\\omega</em>o$与宏观法线方向n的夹角，$\\theta<em>h$是入射光线$\\omega</em>i$与微平面法线方向$\\omega_h$的夹角</p>\n<p>最后问题化简为了求</p>\n<p>$$\\frac{d\\omega<em>h}{d\\omega</em>o}$$</p>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/reflection-03b02468c038b2b2e62e4a9e47540abb-f911d.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 432px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 149.7685185185185%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAABJ0AAASdAHeZh94AAADIElEQVRIx5VWaVPiQBDlb61KyEW4Qw5QkRDlckH2AC3dKi1/e2+/1s4mAdH90JVmpqen3+tjqNi2TRDLsrKvYzsUBCEtFgu6vk4piiIaj8c0GAyo3W6TaZqFM6pDKqrkNxzHobu7De3ud/T88kzr1Yp+/d7SbndP58MhGYaR2ZeDqehirVaTBdwO/fT0VOTk5IQdVHnNFB37ruvKV20LEXqeR5vNhnzfFzj4Xl5e0mQyEZhpmtJ8PqfZbEZJkjAF17IO236/TyuOvtFoZDRIhEEQiCPcjAu63a4Ydzod+YLDXq/Hup+tN5tNkSFTUK/XM9jCIThRyBDoupbXDcNkgZ2ZWzMOc3hMkCTTRPa/URz7DD0VVEBTTig7tHKHrb2saRSA9fqypelNX2CjhOBQufs0QnWKSFqtFp2fD2kxHzNvuMR4h259XDaHBNGl6YSm0xk1PJeaDYMFPL/RcKi4K+Wo1ADOkMU4jt95rHEl1LkS3hwiyqMR5m8CL4B5cXEh3NmWw6ViUhiYXJ+p1CNKyfPqhyPM3wBBZNPpNMsw+FqvErq5CdlJk2uyS2EYSUFr2RR6Od/DKG7I09OTHMB6tWrQdrugOPLp7KzK9rjkTPYQqaAoRwhnugH+0BnoHuiua9MkCVivCn+oySQZ0NVVm78TocD3e7xe+xdh/ha9AAnBYc+z6OFhyX275mirUoePj3+o23GZ3zdbSAYZEHVBk4Kivb1dCrwobFEyDrkmI+YukNqEY9O0sz4ucAiH5fKBIRrf9/s0GnU5UQ7T4HOU33MtVwwm4xCL+VtUkMEoijnjobQaeAUN2nJWCW7mUBfgGJFBPBbHcZmvHv38MZORpQjUTrul4LBc7WqUnzR6QPW8zV5h59vtEOzP9r/Uev8jR4fDMcOv7O/1cnniHIP7kX3lGFRNANoPpVLO6ocR5t9YrS8d7cvlUnoao2y9Xsvzqe+y2hfeZZ19eHfRUpgwOISnFPpoNJLe1fda/47gvYaOUbcHGQfDMBSJZXB6IugMHNQ/AHCA39D1N2zMQ5D1nVXIOsIQIRCojih1xOFMGfJfhkxGtx0n+LMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"reflection\" title=\"\" src=\"/static/reflection-03b02468c038b2b2e62e4a9e47540abb-f911d.png\" srcset=\"/static/reflection-03b02468c038b2b2e62e4a9e47540abb-908da.png 200w,\n/static/reflection-03b02468c038b2b2e62e4a9e47540abb-28198.png 400w,\n/static/reflection-03b02468c038b2b2e62e4a9e47540abb-f911d.png 432w\" sizes=\"(max-width: 432px) 100vw, 432px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<p>可得：</p>\n<p>$$ {d\\omega<em>h} = \\frac{ cos\\theta</em>h}{{|h<em>r|^2}}d\\omega</em>o$$</p>\n<p>由余弦定理：</p>\n<p>$$ \\frac{d\\omega<em>h}{d\\omega</em>o} = \\frac{cos\\theta<em>h}{1+1-2*cos(\\pi-2\\theta</em>h)} =  \\frac{1}{4cos\\theta_h}\\ $$</p>\n<p>法二：</p>\n<p>多重积分换元需要乘一项Jacobian行列式，几何意义代表面积变化的比例\n，在这里可以直接两个面积比(单位球面的角度微元等于面积微元)：$\\lim<em>{d</em>{\\omega<em>o} \\to 0}\\frac{d{\\omega</em>h}}{d{\\omega_o}}$，（硬拿雅克比行列式算过程可参考<a href=\"https://zhuanlan.zhihu.com/p/21489591\">这里</a>）</p>\n<p>法三：</p>\n<p>通过以$\\omega<em>i$作为z轴建立球面坐标系, 因为$\\omega</em>i, \\omega<em>o$关于$\\omega</em>h$对称，$\\theta<em>o’ = 2\\theta</em>h’=2\\theta_h$, 可得：</p>\n<p>$$ d\\omega<em>h=sin \\theta</em>{\\mathrm{h}} \\mathrm{d} \\theta_{\\mathrm{h}} \\mathrm{d} \\phi $$</p>\n<p>$$ d\\omega<em>o=sin2\\theta</em>h <em>2d\\theta_h</em>d\\phi=4sin\\theta<em>hcos\\theta</em>hd\\theta_hd\\phi $$</p>\n<p>化简之后可得：</p>\n<p>$$ \\frac{d\\omega<em>h}{d\\omega</em>o} = \\frac{1}{4cos\\theta_h} \\ $$</p>\n<p>最后再把F、G项带入即可得：</p>\n<p>$$ f<em>{cook-torrance}\\left(\\omega</em>{i},\\omega<em>{o}\\right)=\\frac{F</em>{r}\\left(\\omega<em>{o},\\omega</em>h \\right) D\\left(\\omega<em>{h}\\right) G\\left(\\omega</em>{i}, \\omega<em>{o}\\right)}{4 \\cos \\theta</em>{o} \\cos \\theta_{i}} \\ $$</p>\n<h2>Disney Principled BRDF</h2>\n<p>这里推荐直接一波四合一套餐：</p>\n<p><a href=\"https://github.com/wdas/brdf/blob/main/src/brdfs/disney.brdf\">Disney BRDF Shader</a></p>\n<p><a href=\"https://media.disneyanimation.com/uploads/production/publication_asset/48/asset/s2012_pbs_disney_brdf_notes_v3.pdf\">Disney BRDF Paper</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/60977923\">paper概括</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/57771965\">实践总结</a></p>\n<p>核心microfacet模型：</p>\n<p>$$ f(l,v)=\\textrm{diffuse}+ \\frac{D(\\theta<em>h)F(\\theta</em>d)G(\\theta<em>l,\\theta</em>v)}{4\\ cos\\theta<em>lcos \\theta</em>v} \\ $$</p>\n<p>通过对实际材质、现有公式效果的观察及对比，从而得出最后的经验模型:</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> PI<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span>Fd<span class=\"token punctuation\">,</span> ss<span class=\"token punctuation\">,</span> subsurface<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> Cdlin <span class=\"token operator\">+</span> Fsheen<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> metallic<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> Gs <span class=\"token operator\">*</span> Fs <span class=\"token operator\">*</span> Ds <span class=\"token operator\">+</span> <span class=\"token number\">.25</span> <span class=\"token operator\">*</span> clearcoat <span class=\"token operator\">*</span> Gr <span class=\"token operator\">*</span> Fr <span class=\"token operator\">*</span> Dr<span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>漫反射项：Disney Diffuse</strong></p>\n<p>观察发现Lambert漫反射模型在边缘太暗，最后使用了Schlick近似，但丢弃菲涅尔因子的折射率，并假定没有入射能量的损失，再修改让掠射逆反射（grazing retroreflection response）和粗糙度挂钩，得到一个新的经验模型:</p>\n<p>$$ f<em>d = \\frac{baseColor}{\\pi }(1+(F</em>{D90} -1)(1-cos\\theta <em>l)^{5})(1 + (F</em>{D90}-1)(1-cos\\theta _v)^5)  \\ $$</p>\n<p>$$F<em>{D90} = 0.5 + 2 \\ roughness \\ cos^{2}\\theta</em>d$$</p>\n<p>$\\theta<em>d$ 是入射方向$\\boldsymbol w</em>i$与half vector $\\boldsymbol \\omega<em>h = \\mathrm{normalize(\\boldsymbol w</em>i + \\boldsymbol w_o)}$ 的夹角。</p>\n<p>这样即使$\\theta_d$到90度时，边缘暗度依旧限制在0.5，并且逆反射也随粗糙增加而增加。</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">float</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> u<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">float</span> m <span class=\"token operator\">=</span> <span class=\"token function\">clamp</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">-</span>u<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> m2 <span class=\"token operator\">=</span> m<span class=\"token operator\">*</span>m<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> m2<span class=\"token operator\">*</span>m2<span class=\"token operator\">*</span>m<span class=\"token punctuation\">;</span> <span class=\"token comment\">// pow(m,5)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Diffuse fresnel - go from 1 at normal incidence to .5 at grazing</span>\n<span class=\"token comment\">// and mix in diffuse retro-reflection based on roughness</span>\n<span class=\"token keyword\">float</span> FL <span class=\"token operator\">=</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span>NdotL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FV <span class=\"token operator\">=</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span>NdotV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> Fd90 <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> LdotH<span class=\"token operator\">*</span>LdotH <span class=\"token operator\">*</span> roughness<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> Fd <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> Fd90<span class=\"token punctuation\">,</span> FL<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> Fd90<span class=\"token punctuation\">,</span> FV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>次表面散射部分没有用复杂模型，而是使用了一个BRDF(<a href=\"https://cseweb.ucsd.edu/~ravir/6998/papers/p165-hanrahan.pdf\">Hanrahan-Krueger BRDF</a>的改进)进行近似：</p>\n<p>$$ \\begin{aligned} &#x26;f<em>\\mathrm{subsurface} = 1.25\\frac{\\mathrm{baseColor}}{\\pi}(F</em>{ss} (1 / (\\cos\\theta<em>i + \\cos\\theta</em>o) - 0.5) + 0.5) \\ &#x26;F<em>{ss} = (1 + (F</em>{ss90} - 1)(1 - \\cos\\theta<em>i)^5)(1 + (F</em>{ss90} - 1)(1 - \\cos\\theta<em>o)^5) \\ &#x26;F</em>{ss90} = \\cos^2\\theta_d\\mathrm{roughness} \\end{aligned} \\ $$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token comment\">// Based on Hanrahan-Krueger brdf approximation of isotropic bssrdf</span>\n<span class=\"token comment\">// 1.25 scale is used to (roughly) preserve albedo</span>\n<span class=\"token comment\">// Fss90 used to \"flatten\" retroreflection based on roughness</span>\n<span class=\"token keyword\">float</span> Fss90 <span class=\"token operator\">=</span> LdotH<span class=\"token operator\">*</span>LdotH<span class=\"token operator\">*</span>roughness<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> Fss <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> Fss90<span class=\"token punctuation\">,</span> FL<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> Fss90<span class=\"token punctuation\">,</span> FV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> ss <span class=\"token operator\">=</span> <span class=\"token number\">1.25</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>Fss <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>NdotL <span class=\"token operator\">+</span> NdotV<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">.5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>法线分布项（Specular D）：GTR</strong></p>\n<p>GTR的公式及推导可见paper的附录(p24-p25)</p>\n<p>各项同性：</p>\n<p>$$ D_{GTR} = c/(\\alpha ^{2} cos ^{2}\\theta _h + sin^{2}\\theta _h)^\\gamma \\ $$</p>\n<ul>\n<li>\n<p>γ=1时，GTR即Berry分布</p>\n</li>\n<li>\n<p>γ=2时，GTR即Trowbridge-Reitz分布</p>\n</li>\n</ul>\n<p>Disney BRDF中有两处使用了GTR函数，一处是高光项(各项同性+各项异性)，另一处是清漆的反射。高光项中，$\\gamma$值为2，清漆项中，$\\gamma$值为1</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">float</span> <span class=\"token function\">GTR1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> NdotH<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> a<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">>=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token operator\">/</span>PI<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> a2 <span class=\"token operator\">=</span> a<span class=\"token operator\">*</span>a<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> t <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>a2<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>NdotH<span class=\"token operator\">*</span>NdotH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>a2<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>PI<span class=\"token operator\">*</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a2<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">float</span> <span class=\"token function\">GTR2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> NdotH<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> a<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">float</span> a2 <span class=\"token operator\">=</span> a<span class=\"token operator\">*</span>a<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> t <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>a2<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>NdotH<span class=\"token operator\">*</span>NdotH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> a2 <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>PI <span class=\"token operator\">*</span> t<span class=\"token operator\">*</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>各项异性：</p>\n<p>$$ D(\\theta<em>h, \\phi</em>h) = \\frac{c}{\\left(\\sin^2\\theta<em>h\\left(\\dfrac{\\cos^2\\phi}{\\alpha</em>x^2} + \\dfrac{\\sin^2\\phi}{\\alpha<em>y^2}\\right) + \\cos^2\\theta</em>h\\right)^\\gamma}\\</p>\n<p>$$\n其中：\n$$\n\\begin{aligned} \\alpha<em>x &#x26;= \\mathrm{roughness}^2 / a \\ \\alpha</em>y &#x26;= \\mathrm{roughness}^2 * a \\ a &#x26;= \\sqrt{1 - 0.9\\mathrm{anisotropic}} \\end{aligned}\\\n$$</p>\n<p>由</p>\n<p>$$ \\int<em>{\\mathcal H^2}\\cos\\theta</em>h D(\\theta<em>h, \\phi</em>h)d\\omega_h = 1\\ $$</p>\n<p>及$\\gamma$ = 2，可得：</p>\n<p>$$ \\begin{aligned} &#x26;\\int<em>{\\mathcal H^2}\\frac{c\\cos\\theta</em>h}{\\left(\\sin^2\\theta<em>h\\left(\\frac{\\cos^2\\phi}{\\alpha</em>x^2} + \\frac{\\sin^2\\phi}{\\alpha<em>y^2}\\right) + \\cos^2\\theta\\right)^2}d\\omega</em>h \\ = &#x26;c\\int<em>{0}^{2\\pi}\\int</em>{0}^{\\pi/2}\\frac{\\sin\\theta<em>h\\cos\\theta</em>h}{\\left(\\sin^2\\theta<em>h\\left(\\frac{\\cos^2\\phi}{\\alpha</em>x^2} + \\frac{\\sin^2\\phi}{\\alpha<em>y^2}\\right) + \\cos^2\\theta\\right)^2}d\\theta</em>h d\\phi<em>h \\ = &#x26;\\frac c 2 \\int</em>0^{2\\pi}\\frac 1 {\\frac{\\cos^2\\phi<em>h}{\\alpha</em>x^2} + \\frac{\\sin^2\\phi<em>h}{\\alpha</em>y^2}}d\\phi<em>h = \\pi\\alpha</em>x\\alpha_yc = 1 \\end{aligned}\\\n$$</p>\n<p>解得$c = 1 / (\\pi\\alpha<em>x\\alpha</em>y)$, 即：</p>\n<p>$$ D(\\theta<em>h, \\phi</em>h) = \\frac 1 {\\pi\\alpha<em>x\\alpha</em>y\\left(\\sin^2\\theta<em>h\\left(\\frac{\\cos^2\\phi}{\\alpha</em>x^2} + \\frac{\\sin^2\\phi}{\\alpha<em>y^2}\\right) + \\cos^2\\theta</em>h\\right)^2}\\ $$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">float</span> <span class=\"token function\">GTR2_aniso</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> NdotH<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> HdotX<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> HdotY<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> ax<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> ay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>PI <span class=\"token operator\">*</span> ax<span class=\"token operator\">*</span>ay <span class=\"token operator\">*</span> <span class=\"token function\">sqr</span><span class=\"token punctuation\">(</span> <span class=\"token function\">sqr</span><span class=\"token punctuation\">(</span>HdotX<span class=\"token operator\">/</span>ax<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">sqr</span><span class=\"token punctuation\">(</span>HdotY<span class=\"token operator\">/</span>ay<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> NdotH<span class=\"token operator\">*</span>NdotH <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>NDF关联重要性采样的PDF计算：</p>\n<p>$$ p(\\boldsymbol \\omega<em>i) = p(\\boldsymbol \\omega</em>h)\\frac{d\\omega<em>h}{d\\omega</em>i} = p(\\boldsymbol \\omega<em>h)\\frac{1}{4(\\omega</em>h \\cdot \\omega<em>i)} = \\frac{D(\\theta</em>h, \\phi<em>h)\\cos\\theta</em>h}{4(\\omega<em>h \\cdot \\omega</em>i)}\\ $$</p>\n<p><strong>菲涅尔项（Specular F）：Schlick Fresnel</strong></p>\n<p>Disney使用的还是Schlick Fresnel近似</p>\n<p>$$  F<em>{Schlick}=F</em>0+(1-F_0)(1-cos\\theta _d)^5 \\$$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">float</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> u<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">float</span> m <span class=\"token operator\">=</span> <span class=\"token function\">clamp</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">-</span>u<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> m2 <span class=\"token operator\">=</span> m<span class=\"token operator\">*</span>m<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> m2<span class=\"token operator\">*</span>m2<span class=\"token operator\">*</span>m<span class=\"token punctuation\">;</span> <span class=\"token comment\">// pow(m,5)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">float</span> FH <span class=\"token operator\">=</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span>LdotH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">vec3</span> Fs <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span>Cspec0<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>几何项（Specular G）：Smith-GGX</strong></p>\n<p>Disney使用了Smith GGX导出的G项:</p>\n<p>$$ G\\mathbf{(l,v,h)}= G<em>1{(\\mathbf{l})} \\ G</em>1{(\\mathbf{v})} \\  $$</p>\n<p>各项同性：</p>\n<p>$$ G\\mathbf{(l,v,h)}= G<em>1{(\\mathbf{l})} \\ G</em>1{(\\mathbf{v})} \\<br>\nG_1(\\mathbf{v})=\\frac{2 (\\mathbf{n\\cdot v})}{(\\mathbf{n\\cdot v}) + \\sqrt{\\alpha ^{2}+(1- \\alpha^{2})(\\mathbf{n\\cdot v)^{2}}}}\n$$</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">float</span> <span class=\"token function\">smithG_GGX</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> NdotV<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> alphaG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">float</span> a <span class=\"token operator\">=</span> alphaG<span class=\"token operator\">*</span>alphaG<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> b <span class=\"token operator\">=</span> NdotV<span class=\"token operator\">*</span>NdotV<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>NdotV <span class=\"token operator\">+</span> <span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">+</span> b <span class=\"token operator\">-</span> a<span class=\"token operator\">*</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// clearcoat</span>\n<span class=\"token keyword\">float</span> Gr <span class=\"token operator\">=</span> <span class=\"token function\">smithG_GGX</span><span class=\"token punctuation\">(</span>NdotL<span class=\"token punctuation\">,</span> <span class=\"token number\">.25</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">smithG_GGX</span><span class=\"token punctuation\">(</span>NdotV<span class=\"token punctuation\">,</span> <span class=\"token number\">.25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>各项异性：</p>\n<p>$$ \\begin{aligned} &#x26;G<em>1(\\boldsymbol \\omega) = \\frac 1 {1 + \\Lambda(\\boldsymbol \\omega)} \\ &#x26;\\Lambda(\\boldsymbol \\omega) = -\\frac 1 2 + \\frac 1 2 \\sqrt{1 + (\\alpha</em>x^2\\cos^2\\phi + \\alpha_y^2\\sin^2\\phi)\\tan^2\\theta} \\end{aligned}\\ $$</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">float</span> <span class=\"token function\">smithG_GGX_aniso</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> NdotV<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> VdotX<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> VdotY<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> ax<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> ay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>NdotV <span class=\"token operator\">+</span> <span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span> <span class=\"token function\">sqr</span><span class=\"token punctuation\">(</span>VdotX<span class=\"token operator\">*</span>ax<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">sqr</span><span class=\"token punctuation\">(</span>VdotY<span class=\"token operator\">*</span>ay<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">sqr</span><span class=\"token punctuation\">(</span>NdotV<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">float</span> Gs<span class=\"token punctuation\">;</span>\nGs  <span class=\"token operator\">=</span> <span class=\"token function\">smithG_GGX_aniso</span><span class=\"token punctuation\">(</span>NdotL<span class=\"token punctuation\">,</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">,</span> X<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">,</span> Y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ax<span class=\"token punctuation\">,</span> ay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGs <span class=\"token operator\">*</span><span class=\"token operator\">=</span> <span class=\"token function\">smithG_GGX_aniso</span><span class=\"token punctuation\">(</span>NdotV<span class=\"token punctuation\">,</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> X<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> Y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ax<span class=\"token punctuation\">,</span> ay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>Sheen</strong></p>\n<p>通过对布料材质的观察，发现缺了一个类似菲涅尔项的额外的掠射反射量。Disney BRDF也就直接多加了个缩放的Schlick公式来进行模拟: $sheen * (1 - \\cos\\theta_d)^5$，并且还添加sheenTint参数进行颜色控制</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec3</span> Cdlin <span class=\"token operator\">=</span> <span class=\"token function\">mon2lin</span><span class=\"token punctuation\">(</span>baseColor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> Cdlum <span class=\"token operator\">=</span> <span class=\"token number\">.3</span><span class=\"token operator\">*</span>Cdlin<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token number\">.6</span><span class=\"token operator\">*</span>Cdlin<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">+</span> <span class=\"token number\">.1</span><span class=\"token operator\">*</span>Cdlin<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// luminance approx.</span>\n<span class=\"token keyword\">vec3</span> Ctint <span class=\"token operator\">=</span> Cdlum <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> Cdlin<span class=\"token operator\">/</span>Cdlum <span class=\"token punctuation\">:</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// normalize lum. to isolate hue+sat</span>\n<span class=\"token keyword\">vec3</span> Cspec0 <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span>specular<span class=\"token operator\">*</span><span class=\"token number\">.08</span><span class=\"token operator\">*</span><span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Ctint<span class=\"token punctuation\">,</span> specularTint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Cdlin<span class=\"token punctuation\">,</span> metallic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">vec3</span> Csheen <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Ctint<span class=\"token punctuation\">,</span> sheenTint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> FH <span class=\"token operator\">=</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span>LdotH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">vec3</span> Fsheen <span class=\"token operator\">=</span> FH <span class=\"token operator\">*</span> sheen <span class=\"token operator\">*</span> Csheen<span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>ClearCoat</strong></p>\n<p>清漆项的次级波瓣，F项固定取折射率为1.5的绝缘体，NDF取$\\gamma = 1$的各向同性GTR函数，G项是直接固定粗糙度为0.25的GGX遮蔽项：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token comment\">// clearcoat (ior = 1.5 -> F0 = 0.04)</span>\n<span class=\"token keyword\">float</span> Dr <span class=\"token operator\">=</span> <span class=\"token function\">GTR1</span><span class=\"token punctuation\">(</span>NdotH<span class=\"token punctuation\">,</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">.1</span><span class=\"token punctuation\">,</span><span class=\"token number\">.001</span><span class=\"token punctuation\">,</span>clearcoatGloss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> Fr <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">.04</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> FH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> Gr <span class=\"token operator\">=</span> <span class=\"token function\">smithG_GGX</span><span class=\"token punctuation\">(</span>NdotL<span class=\"token punctuation\">,</span> <span class=\"token number\">.25</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">smithG_GGX</span><span class=\"token punctuation\">(</span>NdotV<span class=\"token punctuation\">,</span> <span class=\"token number\">.25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Fin => .25*clearcoat*Gr*Fr*Dr</span></code></pre></div>\n<h3><strong>汇总</strong></h3>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/BRDFModel-86e374ab5255614a385b4e92fe9fb4a8-2fe46.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 442px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 67.42081447963801%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACbElEQVQ4y31TaU/bQBTM//8L/YhUiUotpVVbriQ0RSHgOr7Xjte3czhOCOSGAJq+XVKJVKiWRs/P0o7fzLyt4I1nOBxCURRomgbTNMEYQ7VaRa1Wk/3/nspsNkO3m2NYFCiKAUoiS9MEtm0RYRvttgrLMqm3oes6OOfo9/t0pruDNE3x/PyMSq/Xk43NPBiWA51gOi4cz4frB2AdDj8IcXt7i7u7O0wmE4xGI4zHYwnxLr65rovNZoPKaFRCt100O0O00xm0bAY1mUIJJ7jiY1xT/WnE0obVaon5fI7FYrGD1WqFOI63hOUQmu3hKrjB3pe6xP5REx+rCt7tf8ePlosW/cw0LdzfryEs+heCNAzDv4QlfhsO6lYPVT3DiRrhTEtRN3PUjAwNVqCuJzAME0EQYDqdYrlcyjolMlF3CAsKIydT3SCFF+XoEET1wkyC0XeXx5JEyBZelTTEer3GmqSuyQYheYcwy3I4PKXDmYRDJAIszCUcP5YBPDw8SImcJuW+D7sTQmOBDOaVhyVUklwjifUtzkm+wJmWkGwhPYVFWzC5uaHDlC4F+fW4hqNrjl9kSVP3EdA6PT4+oiL2zmA+TtUQ77818OHkUgZyUFexd0gBHTdxwfq4VjWkSYKIJmGOhYPjBo4UjsOGiXMthOd5eHp6eplQs9jLoWCMK79EawvRK9EEF3aOOMmwIckiAFF5lOLS7dFqjWB6IaJo6+FgMJAmR0kKHsYIolegnocRTZVI78QOvqyJCKjAyekpPh18hm1ZSGh6SSiukUhvsZi/uWPzbRU3RdwIAfEuhhA3LElidOm2+RSS8PAP3eGv3TRe/MAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"BRDFModel\" title=\"\" src=\"/static/BRDFModel-86e374ab5255614a385b4e92fe9fb4a8-2fe46.jpg\" srcset=\"/static/BRDFModel-86e374ab5255614a385b4e92fe9fb4a8-90a65.jpg 200w,\n/static/BRDFModel-86e374ab5255614a385b4e92fe9fb4a8-5fe86.jpg 400w,\n/static/BRDFModel-86e374ab5255614a385b4e92fe9fb4a8-2fe46.jpg 442w\" sizes=\"(max-width: 442px) 100vw, 442px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<p>$$\n\\begin{aligned} f<em>\\text{disney}(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o) =~&#x26;\\left(\\frac{C}{\\pi}\\mathrm{mix}(f</em>d(\\boldsymbol \\omega<em>i, \\boldsymbol \\omega</em>o), f<em>{ss}(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o), \\sigma</em>{ss}) + f<em>{sh}(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o)\\right) (1 - \\sigma</em>m)\\ +~&#x26;\\frac{F<em>s(\\theta</em>d)G<em>s(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o)D</em>s(\\boldsymbol \\omega<em>h)}{4\\cos\\theta</em>i\\cos\\theta<em>o} \\ +~&#x26;\\frac {\\sigma</em>c} 4 \\frac{F<em>c(\\theta</em>d)G<em>c(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o)D</em>c(\\boldsymbol \\omega<em>i, \\boldsymbol \\omega</em>o)}{4\\cos\\theta<em>i\\cos\\theta</em>o} \\end{aligned}\\\n$$</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> PI<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span>Fd<span class=\"token punctuation\">,</span> ss<span class=\"token punctuation\">,</span> subsurface<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> Cdlin <span class=\"token operator\">+</span> Fsheen<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> metallic<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> Gs <span class=\"token operator\">*</span> Fs <span class=\"token operator\">*</span> Ds <span class=\"token operator\">+</span> <span class=\"token number\">.25</span> <span class=\"token operator\">*</span> clearcoat <span class=\"token operator\">*</span> Gr <span class=\"token operator\">*</span> Fr <span class=\"token operator\">*</span> Dr<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Disney BRDF的所有参数：</p>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/BRDFParam-82a0621d6958cbf7e01cea05fe425f0e-9682a.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 77.44565217391303%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAABoqxNaCRH/8QAGBABAAMBAAAAAAAAAAAAAAAAAAEREgL/2gAIAQEAAQUCum2nakP/xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQMBAT8BEsv/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPwGH/8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABoQAQACAwEAAAAAAAAAAAAAAAEAETFRcUH/2gAIAQEAAT8hdY9nCFvCFQrctqFrE//aAAwDAQACAAMAAAAQW/8A/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAh/9oACAEDAQE/EAGyz//EABYRAQEBAAAAAAAAAAAAAAAAAAARAf/aAAgBAgEBPxDaR//EABoQAAMBAQEBAAAAAAAAAAAAAAABESFBcfD/2gAIAQEAAT8QXp0OaGvB1OHiIAuun3aE2vR//9k=&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"BRDFParam\" title=\"\" src=\"/static/BRDFParam-82a0621d6958cbf7e01cea05fe425f0e-78f2b.jpg\" srcset=\"/static/BRDFParam-82a0621d6958cbf7e01cea05fe425f0e-dce19.jpg 200w,\n/static/BRDFParam-82a0621d6958cbf7e01cea05fe425f0e-c1413.jpg 400w,\n/static/BRDFParam-82a0621d6958cbf7e01cea05fe425f0e-78f2b.jpg 800w,\n/static/BRDFParam-82a0621d6958cbf7e01cea05fe425f0e-9682a.jpg 1104w\" sizes=\"(max-width: 800px) 100vw, 800px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<p>$$\n\\begin{aligned} C &#x26;= \\mathrm{baseColor} \\ \\sigma<em>m &#x26;= \\mathrm{metallic} \\ \\sigma</em>{ss} &#x26;= \\mathrm{subsurface} \\ \\sigma<em>s &#x26;= \\mathrm{specular} \\ \\sigma</em>{st} &#x26;= \\mathrm{specularTint} \\ \\sigma<em>r &#x26;= \\mathrm{roughness} \\ \\sigma</em>a &#x26;= \\mathrm{anisotropic} \\ \\sigma<em>{sh} &#x26;= \\mathrm{sheen} \\ \\sigma</em>{sht} &#x26;= \\mathrm{sheenTint} \\ \\sigma<em>{c} &#x26;= \\mathrm{clearcoat} \\ \\sigma</em>{cg} &#x26;= \\mathrm{clearcoatGloss} \\end{aligned}\\\n$$</p>\n<p>其中$f_d$为漫反射：</p>\n<p>$$\n\\begin{aligned} f<em>d(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o) &#x26;= (1 + (F</em>{D90} - 1)(1 - \\cos\\theta<em>i)^5)(1 + (F</em>{D90} - 1)(1 - \\cos\\theta<em>o)^5) \\ F</em>{D90} &#x26;= 0.5 + 2\\cos^2\\theta<em>d\\sigma</em>r \\end{aligned}\\\n$$</p>\n<p>$f_{ss}$为次表面散射项：</p>\n<p>$$\n\\begin{aligned} f<em>{ss}(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o) &#x26;= 1.25(F</em>{ss} (1 / (\\cos\\theta<em>i + \\cos\\theta</em>o) - 0.5) + 0.5) \\ F<em>{ss} &#x26;= (1 + (F</em>{ss90} - 1)(1 - \\cos\\theta<em>i)^5)(1 + (F</em>{ss90} - 1)(1 - \\cos\\theta<em>o)^5) \\ F</em>{ss90} &#x26;= \\cos^2\\theta<em>d\\sigma</em>r \\end{aligned}\\\n$$</p>\n<p>$f_{sh}$为sheen项：</p>\n<p>$$\n\\begin{aligned} f<em>{sh}(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o) &#x26;= \\mathrm{mix}(\\mathrm{one}, C</em>{tint}, \\sigma<em>{sht})\\sigma</em>{sh}(1 - \\cos\\theta<em>d)^5 \\ C</em>{tint} &#x26;= \\frac{C}{\\mathrm{lum}(C)} \\end{aligned}\\</p>\n<p>\\mathrm{lum}(C) \\approx 0.2126 \\times C.r + 0.7152 \\times C.g + 0.0722 \\times C.b\\\n$$</p>\n<p>$F<em>{s}$是高光的frensel项，用Schlick公式做了近似。对绝缘体而言，Schlick公式中的垂直入射反射比例 $R</em>{0}$可以用一个实数表示；而对金属而言，$R_{0}$是带有颜色信息的，也就是金属工作流，因此Disney BRDF利用金属度参数在两种情况间进行了插值：</p>\n<p>$$\n\\begin{aligned} F<em>s(\\theta</em>d) &#x26;= C<em>s + (1 - C</em>s)(1 - \\cos\\theta<em>d)^5 \\ C</em>s &#x26;= \\mathrm{mix}(0.08\\sigma<em>s\\mathrm{mix}(\\mathrm{one}, C</em>{tint}, \\sigma<em>{st}), C, \\sigma</em>m) \\end{aligned}\\\n$$</p>\n<p>$G_{s}$是高光的遮蔽项，采用各向异性GGX对应的Smith函数</p>\n<p>$$\n\\begin{aligned} G<em>s(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o) &#x26;= G</em>{s1}(\\boldsymbol \\omega<em>i)G</em>{s1}(\\boldsymbol \\omega<em>o) \\ G</em>{s1}(\\boldsymbol \\omega) &#x26;= \\frac 1 {1 + \\Lambda<em>s(\\boldsymbol \\omega)} \\ \\Lambda</em>s(\\boldsymbol \\omega) &#x26;= -\\frac 1 2 + \\frac 1 2 \\sqrt{1 + (\\alpha<em>x^2\\cos^2\\phi + \\alpha</em>y^2\\sin^2\\phi)\\tan^2\\theta} \\end{aligned}\\\n$$</p>\n<p>$D_{s}$是高光的微表面法线分布函数，采用各向异性GTR2函数（其实就是GGX）：</p>\n<p>$$\n\\begin{aligned} D<em>s(\\boldsymbol \\omega</em>h) &#x26;= \\frac 1 {\\pi\\alpha<em>x\\alpha</em>y\\left(\\sin^2\\theta<em>h\\left(\\frac{\\cos^2\\phi}{\\alpha</em>x^2} + \\frac{\\sin^2\\phi}{\\alpha<em>y^2}\\right) + \\cos^2\\theta</em>h\\right)^2} \\ \\alpha<em>x &#x26;= \\sigma</em>r^2 / a \\ \\alpha<em>y &#x26;= \\sigma</em>r^2 a \\ a &#x26;= \\sqrt{1 - 0.9\\sigma_a} \\end{aligned}\\\n$$</p>\n<p>$F_{c}$是清漆的fresnel项，采用折射率固定为1.5的绝缘体对应的Schlick公式：</p>\n<p>$$\nF<em>c(\\theta</em>d) = 0.04 + 0.96(1 - \\cos\\theta_d)^5\\\n$$</p>\n<p>$G_{c}$是清漆的遮蔽项，采用粗糙度为0.25的各向同性GGX对应的Smith函数：</p>\n<p>$$\n\\begin{aligned} G<em>c(\\boldsymbol \\omega</em>i, \\boldsymbol \\omega<em>o) &#x26;= G</em>{c1}(\\boldsymbol \\omega<em>i)G</em>{c1}(\\boldsymbol \\omega<em>o) \\ G</em>{c1}(\\boldsymbol \\omega) &#x26;= \\frac 1 {1 + \\Lambda<em>c(\\boldsymbol \\omega)} \\ \\Lambda</em>c(\\boldsymbol \\omega) &#x26;= -\\frac 1 2 + \\frac 1 2 \\sqrt{1 + \\alpha^2\\tan^2\\theta} \\end{aligned}\\\n$$</p>\n<p>$D_{c}$是清漆的微表面法线分布，采用各向同性的GTR1函数：</p>\n<p>$$\n\\begin{aligned} D<em>c(\\boldsymbol \\omega</em>h) &#x26;= \\frac {\\alpha^2 - 1} {2\\pi\\ln\\alpha(\\alpha^2\\cos^2\\theta<em>h + \\sin^2\\theta</em>h)} \\ \\alpha &#x26;= \\mathrm{mix}(0.1, 0.01, \\sigma_{cg}) \\end{aligned}\\\n$$</p>\n<h2><strong>Disney BSDF</strong></h2>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/ModelCompare-b448f76a0271da3fc62cfa10b5ccb6cc-c907a.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 30.949720670391063%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABJ0AAASdAHeZh94AAABHklEQVQY011QyW7CMBTk/7+Ia0+gqgdoIEUJtpKQBWdxYgeRFabPCYtaS+PxPD+P7VngMe73+8y3EV3boO/7V+3RMaHtOtpvX3q83d5niRdmmjRNSSaxdXxYBxellKi1xjD08CIBJ0hxTgvkmcDWdrHjMRLSl1qjruv/hvMN9jHAcrWH5QY4C4FEZBjopetvF8u1jQPzkec5dscTPvcc3ilGnJyRF+Vfw+dgQYKVxeB4ERzmYWMfTQbY/HB8fNk4xQK2wwgcupJQpaQeF8yP3oZmMQwDOsqmqiooVaEsS2itUBE3TUNaQhYFJMVgakZrikMpNfcSm/PjOM6G5huc8wlhFCEMwwm+H4AxhlSkU88TBZkbNhc8a4Iiul6v+AWM3caWDksOnQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"ModelCompare\" title=\"\" src=\"/static/ModelCompare-b448f76a0271da3fc62cfa10b5ccb6cc-48538.png\" srcset=\"/static/ModelCompare-b448f76a0271da3fc62cfa10b5ccb6cc-bed0f.png 200w,\n/static/ModelCompare-b448f76a0271da3fc62cfa10b5ccb6cc-5fd34.png 400w,\n/static/ModelCompare-b448f76a0271da3fc62cfa10b5ccb6cc-48538.png 800w,\n/static/ModelCompare-b448f76a0271da3fc62cfa10b5ccb6cc-c907a.png 895w\" sizes=\"(max-width: 800px) 100vw, 800px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-68aa3.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.74431818181818%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAQBAgMF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAedC1IZMA//EABkQAAMBAQEAAAAAAAAAAAAAAAABAgMQE//aAAgBAQABBQLeDaWeDLHz/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABoQAAICAwAAAAAAAAAAAAAAAAAxAjIBIEH/2gAIAQEABj8CikRquFsaf//EABoQAAIDAQEAAAAAAAAAAAAAAAERACFBEDH/2gAIAQEAAT8hICCE3oxR09wQrUOYmOf/2gAMAwEAAgADAAAAEHQf/8QAFhEBAQEAAAAAAAAAAAAAAAAAABEh/9oACAEDAQE/EKx//8QAGBEAAgMAAAAAAAAAAAAAAAAAAAERIVH/2gAIAQIBAT8QTUQ9P//EAB0QAQACAgMBAQAAAAAAAAAAAAEAESExQVFxYaH/2gAIAQEAAT8QIFofOfmfkXUQpsFgG+2E5lGCtXxN/M18Tqf/2Q==&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"BSDFModel\" title=\"\" src=\"/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-78f2b.jpg\" srcset=\"/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-dce19.jpg 200w,\n/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-c1413.jpg 400w,\n/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-78f2b.jpg 800w,\n/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-ab4c4.jpg 1200w,\n/static/BSDFModel-f2d33a0edf607beeca22afb186dc489d-68aa3.jpg 1408w\" sizes=\"(max-width: 800px) 100vw, 800px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<p>Disney BRDF本质是金属BRDF和非金属BRDF的插值模型(通过metallic)，而Disney BSDF本质是金属BRDF、非金属BRDF、与Specular BSDF三者的插值模型(通过specTrans、metallic)。</p>\n<h3><strong>Dielectric BRDF + Subsurface</strong></h3>\n<p><strong>先回看BRDF的Fd：</strong></p>\n<p>$$ f<em>{d} = \\frac{baseColor}{\\pi}\\left( 1 +\\left( F</em>{D90} - 1  \\right) \\left( 1 - cos \\theta<em>{l} \\right)^{5} \\right)\\left( 1 +\\left( F</em>{D90} - 1  \\right) \\left( 1 - cos \\theta_{v} \\right)^{5} \\right) $$</p>\n<p>$$ F<em>{D90} = 0.5 + 2 \\times roughness\\times cos^{2}\\theta</em>{d} $$</p>\n<p>1.光滑的次表面散射模型</p>\n<p>Diffuse入的能量自然是扣完反射部分的，也就是1-菲涅尔项(即$1-\\left( 1 - \\left(n \\cdot l\\right)^{+} \\right)^{5}$)，出的时候还得再扣一次，也就是再乘$1-\\left( 1 - \\left(n \\cdot v\\right)^{+} \\right)^{5}$</p>\n<p>2.粗糙的次表面散射模型</p>\n<p>需要考虑补上逆射（retro-reflection）效果，表面越粗糙，在掠射角处，反而有越多的微平面是垂直于光线的现象。观察到兰伯特漫反射边缘本就很暗，再加上1-菲涅尔项项，结果变得更暗。</p>\n<p>BRDF的Fd就是混合了两个模型的经验模型，直观上看很矛盾：越掠射菲涅尔反射越强，所以留给次表面散射的能量就少，但是逆射又越强。那么到底谁强谁弱呢，取决于粗糙度，$F_{D90}$ 大于1时，越掠射反射越强；小于1时，越掠射反射越弱。而粗糙度决定了这个临界点出现的早晚</p>\n<p><strong>BSDF对Fd的改进：</strong></p>\n<p>1.具体思路是将漫反射波瓣重构为两部分: 方向性的微表面效应（microsurface effect），主要为逆反射（retroreflection）；非方向性的次表面效应（subsurface effect），即Lambertian漫反射。</p>\n<p>为了扩展支持次表面散射，首先将漫反射波瓣重构为两部分：方向性微表面效果(主要就是逆射增益)和非方向性（即Lambertian）次表面效果，然后再用扩散模型或体积散射模型去替换Lambertian部分。这样就保留下微表面效果的同时支持了次表面散射，当散射距离较小时，散射模型也可以收敛到与原BRDF相同的结果：</p>\n<p>$$<br>\nf<em>{d} = f</em>{Lambert}\\left( 1 - 0.5F<em>{L} \\right)\\left( 1 - 0.5F</em>{V} \\right) + f<em>{retro-reflection}\n$$\n$$\nf</em>{Lambert} = \\frac{baseColor}{\\pi}\n$$\n$$\nf<em>{retro-reflection} = \\frac{baseColor}{\\pi}R</em>{R}\\left( F<em>{L} + F</em>{V} + F<em>{L}F</em>{V}\\left( R_{R} - 1 \\right) \\right)\n$$</p>\n<p>其中：\n$$\nF<em>{L} = \\left( 1 - cos \\theta</em>{l} \\right)^{5}\n$$\n$$\nF<em>{V} = \\left( 1 - cos \\theta</em>{v} \\right)^{5}\n$$\n$$\nR<em>{R} =2 \\times roughness\\times cos^{2}\\theta</em>{d}\n$$</p>\n<p><strong>Subsurface diffusion：</strong></p>\n<p>Disney通过蒙特卡洛模拟（Monte Carlo simulation），观察到对于典型的散射参数，包括单次散射的扩散剖面（diffusion profile），使用两个指数项的总和（a sum of two exponentials）便可以很好地进行模拟，且得到了比偶极子剖面（dipole diffusion）更好的渲染结果。</p>\n<p>通过观察发现能由两个指数之和很好地近似包括单次散射的散射曲线：</p>\n<p>$$\nR_{d}\\left( r \\right) = \\frac{e^{-\\frac{r}{d}}+e^{-\\frac{r}{3d}}}{8\\pi dr}\n$$</p>\n<p>扩散模型本质上仍然只是对次表面散射的近似，是用公式对真实次表面散射随扩散距离变化曲线的拟合</p>\n<p>其中，d是艺术家调整的平均扩散距离（物理上取决于albedo和平均自由程），r就是采样点与当前要评估brdf的着色点之间的距离。只要采样周围点的入射光，并乘以该距离对应的反射率$R_{d}$即可。</p>\n<p>直言Todo</p>\n<h3><strong>Specular BSDF（Bidirectional Scattering Distribution Function）</strong></h3>\n<p>Specular BSDF = Specular BRDF + Specular BTDF（Bidirectional transmittance distribution function）, BRDF的微平面反射lobe扩展到折射，积分域从半球扩展到整个球。</p>\n<p>$$ f<em>{s}\\left( i,o,n \\right)  = f</em>{r}\\left( i,o,n \\right)  + f_{t}\\left( i,o,n \\right) $$</p>\n<p>反射与折射的半矢量：</p>\n<p>$$h_{r} = \\frac{i + o}{\\left|\\left| i + o \\right|\\right|}$$</p>\n<p>$$h_{t} = - \\frac{i + \\eta  o}{\\left| \\left| i + \\eta o \\right|\\right|}$$</p>\n<p>推导： </p>\n<p>$$\n\\eta<em>{i} \\theta</em>{i} = \\eta<em>{o} \\theta</em>{o}\n$$</p>\n<p>$$\n\\eta =  \\frac{\\eta<em>{o}}{\\eta _{i}}  = \\frac{\\theta</em>{i}}{\\theta<em>{o}} = \\frac{cos\\left( \\frac{\\pi}{2} - \\theta</em>{i} \\right)}{cos\\left( \\frac{\\pi}{2} - \\theta<em>{o} \\right)} = \\frac{h</em>{t} \\cdot i}{-h<em>{t} \\cdot o} => h</em>{t} = - \\frac{i + \\eta  o}{\\left| \\left| i + \\eta o \\right|\\right|}\n$$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">bool</span> refl <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> L<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>refl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    H <span class=\"token operator\">=</span> <span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span>L <span class=\"token operator\">+</span> V<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    H <span class=\"token operator\">=</span> <span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span>L <span class=\"token operator\">+</span> V <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>eta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span>\n    H <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>H<span class=\"token punctuation\">;</span></code></pre></div>\n<p>brdf和btdf的推导：</p>\n<p><a href=\"https://www.pbr-book.org/3ed-2018/Reflection_Models/Microfacet_Models\">https://www.pbr-book.org/3ed-2018/Reflection<em>Models/Microfacet</em>Models</a></p>\n<p>由前面cook-torrance的推导：</p>\n<p>$$ f<em>{cook-torrance}\\left(\\omega</em>{i}, \\omega<em>{o}\\right)=\\frac{d L</em>{o}\\left(\\omega<em>{o}\\right)}{d E</em>{i}\\left(\\omega<em>{i}\\right)}=\\frac{d L</em>{o}\\left(\\omega<em>{o}\\right)}{L</em>{i}\\left(\\omega<em>{i}\\right) \\cos \\theta</em>{i} d \\omega<em>{i}}=\\frac{\\cos \\theta</em>{h} D\\left(\\omega<em>{h}\\right) d \\omega</em>{h}}{\\cos \\theta<em>{o} \\cos \\theta</em>{i} d \\omega_{o}} \\ $$</p>\n<p>之前只考虑了反射，这里还需要考虑折射的情况：</p>\n<p>问题又回到了求</p>\n<p>$$\\frac{d\\omega<em>m}{d\\omega</em>o}$$</p>\n<p>由相似三角形以及定义公式：</p>\n<p>$$d\\omega = \\frac{dA}{r^2}$$</p>\n<p>可得： </p>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/dwm_dwo-87bef904bfecc332b1752e95d9461b62-34f26.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 720px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 72.36111111111111%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEE/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkAP/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFxABAQEBAAAAAAAAAAAAAAAAAAExEf/aAAgBAQABPyGYmrriLr//2gAMAwEAAgADAAAAEJPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwADAQAAAAAAAAAAAAAAAAERITFRQf/aAAgBAQABPxCmy84XMcY2Um+CZp5NrYIqyf/Z&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"dwm dwo\" title=\"\" src=\"/static/dwm_dwo-87bef904bfecc332b1752e95d9461b62-34f26.jpg\" srcset=\"/static/dwm_dwo-87bef904bfecc332b1752e95d9461b62-a3779.jpg 200w,\n/static/dwm_dwo-87bef904bfecc332b1752e95d9461b62-3e4a1.jpg 400w,\n/static/dwm_dwo-87bef904bfecc332b1752e95d9461b62-34f26.jpg 720w\" sizes=\"(max-width: 720px) 100vw, 720px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<p>对于反射的情况，带入可得：</p>\n<p>$$\nf<em>{r}\\left( i, o \\right) = \\frac{ \\left| i \\cdot h</em>{r} \\right| \\left| o \\cdot h<em>{r} \\right|}          { cos\\theta</em>{i}cos\\theta<em>{o} \\left| \\left| i + o \\right| \\right|^{2}} F \\left( i, h</em>{r} \\right)G\\left( i, o, m \\right)D\\left( m \\right)\n$$</p>\n<p>最后化简可得：</p>\n<p>$$\nf<em>{r}\\left( i, o \\right) = \\frac{F \\left( i, h</em>{r} \\right) G\\left( i, o, m \\right)D\\left( m \\right) }          { 4cos\\theta<em>{i}cos\\theta</em>{o}}\n$$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec3</span> <span class=\"token function\">EvalDielectricReflection</span><span class=\"token punctuation\">(</span>SurfaceInteraction si<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> V<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> N<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> L<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> H<span class=\"token punctuation\">,</span> <span class=\"token keyword\">inout</span> <span class=\"token keyword\">float</span> pdf<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pdf <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> L<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">float</span> F <span class=\"token operator\">=</span> <span class=\"token function\">DielectricFresnel</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>eta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> D <span class=\"token operator\">=</span> <span class=\"token function\">GTR2</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>roughness<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// MicrofacetReflection::Sample_f</span>\n    pdf <span class=\"token operator\">=</span> D <span class=\"token operator\">*</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> F <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4.0</span> <span class=\"token operator\">*</span> <span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">float</span> G <span class=\"token operator\">=</span> <span class=\"token function\">SmithG_GGX</span><span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> L<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>roughness<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">SmithG_GGX</span><span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> V<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>roughness<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> si<span class=\"token punctuation\">.</span>color <span class=\"token operator\">*</span> F <span class=\"token operator\">*</span> D <span class=\"token operator\">*</span> G<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>折射的情况带入，没得化简，直接可得：</p>\n<p>$$\nf<em>{r}\\left( i, o \\right) = \\frac{ \\left| i \\cdot h</em>{t} \\right| \\left| o \\cdot h<em>{t}  \\right| \\eta^{2}}          { cos\\theta</em>{i}cos\\theta<em>{o} \\left| \\left| i + \\eta o \\right| \\right|^{2}} (1-F \\left( i, h</em>{r} \\right))G\\left( i, o, m \\right)D\\left( m \\right)\n$$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token comment\">// https://www.pbr-book.org/3ed-2018/Reflection_Models/Microfacet_Models</span>\n<span class=\"token keyword\">vec3</span> <span class=\"token function\">EvalDielectricRefraction</span><span class=\"token punctuation\">(</span>SurfaceInteraction si<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> V<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> N<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> L<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> H<span class=\"token punctuation\">,</span> <span class=\"token keyword\">inout</span> <span class=\"token keyword\">float</span> pdf<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pdf <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> L<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">float</span> F <span class=\"token operator\">=</span> <span class=\"token function\">DielectricFresnel</span><span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>eta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> D <span class=\"token operator\">=</span> <span class=\"token function\">GTR2</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>roughness<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// MicrofacetTransmission::Pdf</span>\n    <span class=\"token keyword\">float</span> denomSqrt <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>eta<span class=\"token punctuation\">;</span>\n    pdf <span class=\"token operator\">=</span> D <span class=\"token operator\">*</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span> <span class=\"token operator\">-</span> F<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>denomSqrt <span class=\"token operator\">*</span> denomSqrt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">float</span> G <span class=\"token operator\">=</span> <span class=\"token function\">SmithG_GGX</span><span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> L<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>roughness<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">SmithG_GGX</span><span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> V<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>roughness<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 乘4是补V项多除掉的4</span>\n    <span class=\"token keyword\">return</span> si<span class=\"token punctuation\">.</span>color <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span> <span class=\"token operator\">-</span> F<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> D <span class=\"token operator\">*</span> G <span class=\"token operator\">*</span> <span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">4.0</span> <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>eta <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>eta <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>denomSqrt <span class=\"token operator\">*</span> denomSqrt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>此外的几项：</p>\n<p><strong>1.clearcoat</strong></p>\n<p>直接从BRDF接过来，未做改变，贡献额外的反射，不参与折射</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec3</span> <span class=\"token function\">EvalClearcoat</span><span class=\"token punctuation\">(</span>SurfaceInteraction si<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> V<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> N<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> L<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec3</span> H<span class=\"token punctuation\">,</span> <span class=\"token keyword\">inout</span> <span class=\"token keyword\">float</span> pdf<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">float</span> NDotL <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> L<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    pdf <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NDotL <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">float</span> NDotV <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> V<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> NDotH <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> LDotH <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">float</span> D <span class=\"token operator\">=</span> <span class=\"token function\">GTR1</span><span class=\"token punctuation\">(</span>NDotH<span class=\"token punctuation\">,</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.001</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>clearcoatGloss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    pdf <span class=\"token operator\">=</span> D <span class=\"token operator\">*</span> NDotH <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4.0</span> <span class=\"token operator\">*</span> LDotH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">float</span> FH <span class=\"token operator\">=</span> <span class=\"token function\">SchlickFresnel</span><span class=\"token punctuation\">(</span>LDotH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> F <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.04</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> FH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> G <span class=\"token operator\">=</span> <span class=\"token function\">SmithG_GGX</span><span class=\"token punctuation\">(</span>NDotL<span class=\"token punctuation\">,</span> <span class=\"token number\">0.25</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">SmithG_GGX</span><span class=\"token punctuation\">(</span>NDotV<span class=\"token punctuation\">,</span> <span class=\"token number\">0.25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.25</span> <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>clearcoat <span class=\"token operator\">*</span> F <span class=\"token operator\">*</span> D <span class=\"token operator\">*</span> G<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>2.surface absorption</strong>（表面吸收）</p>\n<p>将折射结果乘以表面颜色的平方根，在考虑了进入和离开的散射事件后，产生预期反射率</p>\n<p>ToCheck in pbrt</p>\n<p><strong>3.volumetric absorption</strong>（体积吸收）</p>\n<p>根据折射路径长度来应用体积吸收，并且参数化。</p>\n<p>由Beer-Lambert定律可得公式：</p>\n<p>$$T = e^{−σ_{a} d}$$</p>\n<p>其中：T为透射率，$σ_{a}$为吸收系数，d为距离。则通过增加两个参数透射颜色(extinction)和距离系数(atDistance)，就可以反转透射方程来计算吸收系数：</p>\n<p>$$σ_{a} = -log(T)/d$$</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">.</span>normal<span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>ffnormal<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tpath<span class=\"token punctuation\">.</span>absorption <span class=\"token operator\">=</span> <span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ToCheck: why exp here</span>\npath<span class=\"token punctuation\">.</span>beta <span class=\"token operator\">*</span><span class=\"token operator\">=</span> <span class=\"token function\">exp</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>path<span class=\"token punctuation\">.</span>absorption <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">.</span>ffnormal<span class=\"token punctuation\">,</span> bsdfSampleRec<span class=\"token punctuation\">.</span>L<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tpath<span class=\"token punctuation\">.</span>absorption <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">.</span>extinction<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> si<span class=\"token punctuation\">.</span>atDistance<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>4.sheen</strong></p>\n<p>也是直接从BRDF接过来，未做改变。尽管是非物理的，但是可以用来补偿当前微表面模型不考虑多次反射/折射所丢失的能量(手动版Kulla-Conty Approximation)</p>\n<p>代码部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec3</span> Csheen <span class=\"token operator\">=</span> <span class=\"token function\">mix</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">vec3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Ctint<span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">.</span>sheenTint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">vec3</span> Fsheen <span class=\"token operator\">=</span> FH <span class=\"token operator\">*</span> si<span class=\"token punctuation\">.</span>sheen <span class=\"token operator\">*</span> Csheen<span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>5.Thin-surface BSDF</strong></p>\n<p>Disney还提供了另一种薄面模型</p>\n<p>未做实践</p>\n<p>1.新增diffTrans参数，用以插值反射的diffuse和透射的diffuse（因为是薄表面，所以可以直接建模成diffuse出去，而不必考虑多次散射）。就是把原本brdf diffuse分到的能量，又分成了两份</p>\n<p>2.透射的diffuse只是简单使用了兰伯特漫反射，而反射出来的diffuse跟原模型一样，只是次表面散射仍然使用ss项简单应付一下，不过改名成了flatness来插值漫反射和次表面散射，以避免与真正的次表面散射混淆。</p>\n<p>3.由于薄表面上的折射引起的弯曲被近似抵消（光线进出相互抵消），所以折射并未改变方向。但是两次折射却会放大或减弱透射模糊，因此还基于IOR缩放透射Specular的粗糙度：</p>\n<p>$$(0.65 * \\eta - 0.35) * rough$$</p>\n<p>整体而言，薄面模型比起固体模型透射模糊效果更淡，但仍随着折射率逐渐变大</p>\n<h3><strong>汇总</strong></h3>\n<p>Blender对Disney BSDF实现的所有参数：</p>\n<div style=\"text-align: center\">  \n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/BSDFParam-1337e1967e95f38c1bc09e731f479417-d603c.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 96.875%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBBf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAAB5NY0ExMQ4wV//8QAGxAAAQUBAQAAAAAAAAAAAAAAAAECEBExEiH/2gAIAQEAAQUCZkNyjwtUOlj/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREQ/9oACAEDAQE/Aairf//EABYRAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAgEBPwEjf//EABkQAAIDAQAAAAAAAAAAAAAAAAAxECAyof/aAAgBAQAGPwJGRcq4/8QAHBAAAwACAwEAAAAAAAAAAAAAAAERIVEQQWGR/9oACAEBAAE/IZqqzGnwa8BcqiNEHUbQ9rj/2gAMAwEAAgADAAAAEM8nAf/EABYRAQEBAAAAAAAAAAAAAAAAAAEgIf/aAAgBAwEBPxAA2H//xAAZEQABBQAAAAAAAAAAAAAAAAAAARAhUXH/2gAIAQIBAT8QlZhX/8QAHxABAAEEAQUAAAAAAAAAAAAAAQARITGRQWGBsdHw/9oACAEBAAE/ECMw5ToRFjW9Ra2LthtwangnzWIODcLAxBoNOIgvvirdas//2Q==&apos;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\" alt=\"BSDFParam\" title=\"\" src=\"/static/BSDFParam-1337e1967e95f38c1bc09e731f479417-78f2b.jpg\" srcset=\"/static/BSDFParam-1337e1967e95f38c1bc09e731f479417-dce19.jpg 200w,\n/static/BSDFParam-1337e1967e95f38c1bc09e731f479417-c1413.jpg 400w,\n/static/BSDFParam-1337e1967e95f38c1bc09e731f479417-78f2b.jpg 800w,\n/static/BSDFParam-1337e1967e95f38c1bc09e731f479417-d603c.jpg 960w\" sizes=\"(max-width: 800px) 100vw, 800px\">\n    </span>\n  </span>\n  \n  </a>\n      \n</div>\n<p>所有lglTracer的实际代码还待检验</p>\n<p>Todo：BSSRDF from Atrc</p>","fields":{"slug":"/lgltracer-material/","prefix":"2021-11-07"},"frontmatter":{"title":"【WebGL与光线追踪】(二) Disney BSDF","author":"todaylg","category":"小结","cover":{"childImageSharp":{"resize":{"src":"/static/cornellBox-4b38ad4d2b4bbfc485fb6609bcb378be-160fa.png"}}}}},"authornote":{"id":"20cdfd79-00b3-57fb-a29f-bb96dcd133a8","html":"<p><strong>todaylg</strong> </p>"},"site":{"siteMetadata":{"facebook":{"appId":""}}}},"pageContext":{"slug":"/lgltracer-material/","prev":{"id":"63fd430c-960e-5cfb-8713-74358727c528","fields":{"slug":"/lgltracer-intro/","prefix":"2021-11-06","source":"posts"},"frontmatter":{"title":"【WebGL与光线追踪】(一) 简介","category":"小结"}},"next":{"id":"1ffb1236-a223-50a0-97df-e34a786c2ca5","fields":{"slug":"/lgltracer-tracing/","prefix":"2021-11-08","source":"posts"},"frontmatter":{"title":"【WebGL与光线追踪】(三) Path Tracing","category":"小结"}},"source":"posts"}}